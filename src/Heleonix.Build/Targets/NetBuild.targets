<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="Hx_NetBuild">
    <Message Text="> STARTING..."/>

    <MSBuild
      Condition="'$(Hx_NetBuild_SlnFile)' == ''"
      Projects="$(MSBuildProjectFullPath)"
      Targets="Hx_Internal_NetFindSln"
      Properties="Hx_Internal_NetFindSln_WSDir=$(Hx_WS_Dir)">
      <Output TaskParameter="TargetOutputs" PropertyName="Hx_NetBuild_SlnFile"/>
    </MSBuild>
    <PropertyGroup>
      <_Hx_NetBuild_SlnDir>$([System.IO.Path]::GetDirectoryName('$(Hx_NetBuild_SlnFile)'))</_Hx_NetBuild_SlnDir>
    </PropertyGroup>

    <PropertyGroup Condition="'$(Hx_NetBuild_Version)' == '' And Exists('$(Hx_ChangeLog_ArtifactsDir)/semver.txt')">
      <Hx_NetBuild_Version>$([System.IO.File]::ReadAllText('$(Hx_ChangeLog_ArtifactsDir)/semver.txt').Trim())</Hx_NetBuild_Version>
    </PropertyGroup>

    <PropertyGroup Condition="'$(Hx_NetBuild_AssemblyVersion)' == '' And '$(Hx_NetBuild_Version)' != ''">
      <Hx_NetBuild_AssemblyVersion>$(Hx_NetBuild_Version).$(Hx_Run_Number)</Hx_NetBuild_AssemblyVersion>
    </PropertyGroup>

    <PropertyGroup Condition="'$(Hx_NetBuild_ReleaseNotesFile)' == '' And Exists('$(Hx_ChangeLog_ArtifactsDir)/ReleaseNotes.txt')">
      <Hx_NetBuild_ReleaseNotesFile>$(Hx_ChangeLog_ArtifactsDir)/ReleaseNotes.txt</Hx_NetBuild_ReleaseNotesFile>
    </PropertyGroup>

    <Message Text="> 1/7: Creating the artifacts directory"/>
    <RemoveDir Directories="$(Hx_NetBuild_ArtifactsDir)"/>
    <MakeDir Directories="$(Hx_NetBuild_ArtifactsDir)"/>

    <Message Text="> 2/7: Deleting files"/>
    <Delete Files="@(Hx_NetBuild_DeleteFiles)"/>

    <Message Text="> 3/7: Deleting directories"/>
    <Heleonix.Build.Tasks.FileSystemSearch
      StartDir="$(_Hx_NetBuild_SlnDir)"
      PathRegExp="/(bin|obj)/$(Hx_In_Configuration)$"
      Types="Directories">
      <Output TaskParameter="FoundDirs" ItemName="Hx_NetBuild_DeleteDirs"/>
    </Heleonix.Build.Tasks.FileSystemSearch>
    <RemoveDir Directories="@(Hx_NetBuild_DeleteDirs)"/>

    <Message Text="> 4/7: Cleaning directories"/>
    <Heleonix.Build.Tasks.DirectoryClean Dirs="@(Hx_NetBuild_CleanDirs)"/>

    <Message Text="> 5/7: Cleaning the solution"/>
    <!--Sometimes Clean is failing without Restore-->
    <MSBuild
      Projects="$(Hx_NetBuild_SlnFile)"
      Targets="Restore;Clean"
      Properties="Configuration=$(Hx_In_Configuration)"
      />

    <Message Text="> 6/7: Building the solution"/>
    <PropertyGroup>
      <_Hx_NetBuild_SigningProps Condition="Exists('$(Hx_NetBuild_SnkFile)')">SignAssembly=true;AssemblyOriginatorKeyFile=$(Hx_NetBuild_SnkFile)</_Hx_NetBuild_SigningProps>
      <_Hx_NetBuild_VersionProps Condition="'$(Hx_NetBuild_Version)' != ''">Version=$(Hx_NetBuild_Version)</_Hx_NetBuild_VersionProps>
      <_Hx_NetBuild_AssemblyVersionProps Condition="'$(Hx_NetBuild_AssemblyVersion)' != ''">AssemblyVersion=$(Hx_NetBuild_AssemblyVersion)</_Hx_NetBuild_AssemblyVersionProps>
      <_Hx_NetBuild_ReleaseNotes Condition="'$(Hx_NetBuild_ReleaseNotesFile)' != ''">PackageReleaseNotes=&quot;$([System.IO.File]::ReadAllText('$(Hx_NetBuild_ReleaseNotesFile)').Trim())&quot;</_Hx_NetBuild_ReleaseNotes>
    </PropertyGroup>
    <MSBuild
      Projects="$(Hx_NetBuild_SlnFile)"
      Targets="Restore;Build"
      Properties="Configuration=$(Hx_In_Configuration);$(_Hx_NetBuild_SigningProps);$(_Hx_NetBuild_VersionProps);$(_Hx_NetBuild_AssemblyVersionProps);$(_Hx_NetBuild_ReleaseNotes)"
      />

    <MSBuild
      Projects="$(MSBuildProjectFullPath)"
      Targets="Hx_Internal_NetFindProjects"
      Properties="Hx_Internal_NetFindProjects_SlnFile=$(Hx_NetBuild_SlnFile)">
      <Output TaskParameter="TargetOutputs" ItemName="_Hx_NetBuild_ProjectFiles"/>
    </MSBuild>
    <!--RegExp: (?<=(?<=<(TargetFrameworks?)>)([^<>]+|))[^;<>]+(?=([^<>]+|)(?=</\1>))-->
    <!--<Heleonix.Build.Tasks.FileRead
      File="%(_Hx_NetBuild_ProjectFiles.FullPath)"
      RegExp="(?&lt;=(?&lt;=&lt;(TargetFrameworks?)&gt;)([^&lt;&gt;]+|))[^;&lt;&gt;]+(?=([^&lt;&gt;]+|)(?=&lt;/%5C1>))">
      <Output TaskParameter="Matches" ItemName="_Hx_NetBuild_TFMProjectFiles"/>
    </Heleonix.Build.Tasks.FileRead>-->
    <!--Passing the same properties as to Build, because sometimes Publish can re-run Build and re-generate assemblies-->
    <!--<MSBuild
      Projects="%(_Hx_NetBuild_TFMProjectFiles.FullPath)"
      Targets="Publish"
      Properties="TargetFramework=%(Match);Configuration=$(Hx_In_Configuration);$(_Hx_NetBuild_SigningProps);$(_Hx_NetBuild_VersionProps);$(_Hx_NetBuild_AssemblyVersionProps);$(_Hx_NetBuild_ReleaseNotes)" />-->

    <Message Text="> 7/7: Copying .sln, all 'bin' and 'obj' folders, all *.props, *.*proj and custom artifacts files to the artifacts directory"/>
    <Heleonix.Build.Tasks.FileSystemSearch
      StartDir="$(Hx_WS_Dir)"
      PathRegExp="(?&lt;!/(bin|obj)/.+)\.props$"
      Types="Files">
      <Output TaskParameter="FoundFiles" ItemName="_Hx_NetBuild_PropsFiles"/>
    </Heleonix.Build.Tasks.FileSystemSearch>
    <ItemGroup>
      <_Hx_NetBuild_ArtifactsFiles Include="$(Hx_NetBuild_SlnFile)">
        <WithSubDirsFrom>$(Hx_WS_Dir)</WithSubDirsFrom>
      </_Hx_NetBuild_ArtifactsFiles>
      <_Hx_NetBuild_ArtifactsFiles Include="$(_Hx_NetBuild_SlnDir)/**/bin/**/*">
        <WithSubDirsFrom>$(Hx_WS_Dir)</WithSubDirsFrom>
      </_Hx_NetBuild_ArtifactsFiles>
      <_Hx_NetBuild_ArtifactsFiles Include="$(_Hx_NetBuild_SlnDir)/**/obj/**/*">
        <WithSubDirsFrom>$(Hx_WS_Dir)</WithSubDirsFrom>
      </_Hx_NetBuild_ArtifactsFiles>
      <_Hx_NetBuild_ArtifactsFiles Include="@(_Hx_NetBuild_PropsFiles)">
        <WithSubDirsFrom>$(Hx_WS_Dir)</WithSubDirsFrom>
      </_Hx_NetBuild_ArtifactsFiles>
      <_Hx_NetBuild_ArtifactsFiles Include="@(_Hx_NetBuild_ProjectFiles)">
        <WithSubDirsFrom>$(Hx_WS_Dir)</WithSubDirsFrom>
      </_Hx_NetBuild_ArtifactsFiles>
      <_Hx_NetBuild_ArtifactsFiles Include="$(Hx_WS_BuildProjFile)">
        <WithSubDirsFrom>$(Hx_WS_Dir)</WithSubDirsFrom>
      </_Hx_NetBuild_ArtifactsFiles>
      <_Hx_NetBuild_ArtifactsFiles Include="@(Hx_NetBuild_CustomArtifactsFiles)">
        <WithSubDirsFrom>$(Hx_WS_Dir)</WithSubDirsFrom>
      </_Hx_NetBuild_ArtifactsFiles>
    </ItemGroup>
    <Heleonix.Build.Tasks.FileCopy
      Files="@(_Hx_NetBuild_ArtifactsFiles)"
      DestinationDirs="$(Hx_NetBuild_ArtifactsDir)"
      Overwrite="true"/>

    <Message Text="> DONE!"/>

    <OnError ExecuteTargets="Hx_OnError"/>
  </Target>
</Project>